apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .FileXdsServerConfigMapName }}
  namespace: {{ .EnvoyGatewayNamespace }}
data:
  # config.yaml is used by filexds server (can contain multiple resources)
  config.yaml: |
    version_info: "1"
    resources:
{{- range .Services }}
    - "@type": type.googleapis.com/envoy.config.endpoint.v3.ClusterLoadAssignment
      cluster_name: "{{ .ServiceName }}"
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: "{{ .ServiceIP }}"
                port_value: {{ .ServicePort }}
{{- end }}
{{ if .TlsCaCertPEM }}
    - "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.Secret
      name: "{{ .TlsCaCertName }}"
      validation_context:
        trusted_ca:
          inline_string: "{{ .TlsCaCertPEM | yamlEscape }}"
{{ end }}

